name: Generate Wrapper, Fix & Build

on:
  workflow_dispatch:

permissions:
  contents: write # PermissÃ£o obrigatÃ³ria para commitar o gradlew

jobs:
  fix-and-build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout do CÃ³digo
      uses: actions/checkout@v4

    - name: â˜• Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ› ï¸ Gerar Gradle Wrapper (CorreÃ§Ã£o do erro "No such file")
      # O sistema gera o arquivo gradlew que estava faltando
      run: gradle wrapper --gradle-version 8.2 --distribution-type bin

    - name: ğŸ”§ Corrigir gradle.properties
      # Remove configuraÃ§Ãµes conflitantes (Jetifier) e garante AndroidX
      run: |
        echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" > gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties

    - name: ğŸ’¾ Commitar CorreÃ§Ãµes e o Gradlew (Push)
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        # Adiciona o script gradlew gerado e as configs
        git add gradlew gradlew.bat gradle/wrapper/gradle-wrapper.properties gradle/wrapper/gradle-wrapper.jar gradle.properties
        
        # SÃ³ commita se houver algo novo (para nÃ£o quebrar se rodar 2x)
        if git diff --staged --quiet; then
          echo "Arquivos jÃ¡ estÃ£o corretos. Nada a commitar."
        else
          git commit -m "Fix: Add missing Gradle Wrapper (8.2) and fix properties"
          git push
          echo "Gradle Wrapper enviado para o repositÃ³rio."
        fi

    - name: âš™ï¸ PermissÃ£o de ExecuÃ§Ã£o
      # Agora vai funcionar porque o passo anterior gerou o arquivo
      run: chmod +x gradlew

    - name: ğŸ§¹ Limpar Cache
      run: ./gradlew clean

    - name: ğŸ”¨ Compilar APK (Debug)
      run: ./gradlew assembleDebug --stacktrace

    - name: ğŸ“¤ Upload do APK
      uses: actions/upload-artifact@v4
      with:
        name: snes-android-debug
        path: app/build/outputs/apk/debug/app-debug.apk
