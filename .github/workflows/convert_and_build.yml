name: Fix, Commit & Build

on:
  workflow_dispatch:

permissions:
  contents: write # PermissÃ£o necessÃ¡ria para o bot fazer o commit

jobs:
  fix-and-build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout do CÃ³digo
      uses: actions/checkout@v4

    - name: â˜• Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ”§ Aplicar CorreÃ§Ãµes (Gradle Wrapper & Properties)
      run: |
        # 1. Recriar Gradle Wrapper com versÃ£o 8.2 (CompatÃ­vel com AGP 8.2.0)
        # Isso resolve incompatibilidades de versÃ£o do Gradle
        mkdir -p gradle/wrapper
        echo "distributionBase=GRADLE_USER_HOME" > gradle/wrapper/gradle-wrapper.properties
        echo "distributionPath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStoreBase=GRADLE_USER_HOME" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStorePath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties

        # 2. Resetar gradle.properties 
        # Removemos o Jetifier pois ele causa o erro "Cannot mutate dependencies"
        echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" > gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties

    - name: ğŸ’¾ Commitar e Enviar CorreÃ§Ãµes (Push)
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        # Adiciona os arquivos modificados
        git add gradle/wrapper/gradle-wrapper.properties gradle.properties
        
        # Verifica se hÃ¡ mudanÃ§as antes de commitar para nÃ£o dar erro
        if git diff --staged --quiet; then
          echo "Nenhuma mudanÃ§a necessÃ¡ria nos arquivos de configuraÃ§Ã£o."
        else
          git commit -m "Fix: Force Gradle 8.2 and remove Jetifier to fix build error"
          git push
          echo "CorreÃ§Ãµes enviadas para o repositÃ³rio."
        fi

    - name: âš™ï¸ PermissÃ£o de ExecuÃ§Ã£o
      run: chmod +x gradlew

    - name: ğŸ§¹ Limpar Cache do Build
      run: ./gradlew clean

    - name: ğŸ”¨ Compilar APK (Debug)
      run: ./gradlew assembleDebug --stacktrace

    - name: ğŸ“¤ Upload do APK
      uses: actions/upload-artifact@v4
      with:
        name: snes-android-debug
        path: app/build/outputs/apk/debug/app-debug.apk
